= *Kubernetes cluster using Kubeadm*

== Docker Installation 

Add the Docker repo to use docker-engine 
[source,shell]
----
tee /etc/yum.repos.d/docker.repo <<-'EOF'
[dockerrepo]
name=Docker Repository
baseurl=https://yum.dockerproject.org/repo/main/centos/7/
enabled=1
gpgcheck=1
gpgkey=https://yum.dockerproject.org/gpg
EOF
----

Install docker-engine
[source,shell]
----
yum install docker-engine -y
----

Make sure that the cgroup driver used by kubelet is the same as the one used by Docker. 
[source,shell]
----
cat << EOF > /etc/docker/daemon.json
{
  "exec-opts": ["native.cgroupdriver=systemd"]
}
EOF
----

Start docker-engine 
[source,shell]
----
systemctl enable docker && systemctl start docker
----

== Kubeadm

== Nodes Installation

[source,shell]
----
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF
----

[source,shell]
----
sed -i '/^SELINUX./ { s/enforcing/disabled/; }' /etc/selinux/config
----

[source,shell]
----
setenforce 0
----

[source,shell]
----
yum install -y kubelet kubeadm kubectl kubernetes-cni
----

[source,shell]
----
systemctl enable docker
----

[source,shell]
----
systemctl enable kubelet && systemctl start kubelet
----

=== Master Installation

Issue: Iptables

[source,shell]
----
$ cat <<EOF >  /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF

$ sysctl --system
----


Issue : https://github.com/kubernetes/kubernetes/issues/53333
[source,shell]
----
sed -e '/^Environment="KUBELET_KUBECONFIG_ARGS/a Environment="KUBELET_EXTRA_ARGS=--fail-swap-on=false"' /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
----

Issue : kubectl get: The connection to the server localhost:8080 was refused -Kubernetes
[source,shell]
----
cp /etc/kubernetes/admin.conf $HOME/
chown $(id -u):$(id -g) $HOME/admin.conf
export KUBECONFIG=$HOME/admin.conf
----

Start Kubeadmin
[source,shell]
----
kubeadm init --apiserver-advertise-address=192.168.1.110 --service-cidr 192.168.1.0/24 --pod-network-cidr 192.168.1.0/24
----

Sources : 

- https://kubernetes.io/docs/setup/independent/install-kubeadm/#installing-docker
- https://www.data-essential.com/hands-on-kubernetes-with-kubeadm/
