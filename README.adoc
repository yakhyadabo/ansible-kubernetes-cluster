= *Kubernetes cluster using Kubeadm*

== Docker CE-17.03 Installation 

Install yum-utils to config-manager
[source,shell]
----
$ yum install -y yum-utils
----

Add Docker Repo
[source,shell]
----
$ yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
----

Install Docker-ce 17.03
[source,shell]
----
$ yum install -y --setopt=obsoletes=0  docker-ce-17.03.0.ce-1.el7.centos  docker-ce-selinux-17.03.0.ce-1.el7.centos
----

More details : https://docs.docker.com/engine/installation/linux/docker-ce/centos/#install-using-the-repository

Start docker-engine 
[source,shell]
----
$ systemctl enable docker.service && systemctl start docker.service
----

Make sure that the cgroup driver used by kubelet is the same as the one used by Docker. 
[source,shell]
----
cat << EOF > /etc/docker/daemon.json
{
  "exec-opts": ["native.cgroupdriver=systemd"]
}
EOF
----

Restart Docker
[source,shell]
----
$ systemctl restart docker.service  
----

== Kubeadm 1.8.3

=== Nodes Installation

[source,shell]
----
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF
----

Disable SELINUX
[source,shell]
----
sed -i '/^SELINUX./ { s/enforcing/disabled/; }' /etc/selinux/config
----

[source,shell]
----
setenforce 0
----

Install kubeadm 1.8.3
[source,shell]
----
$ yum install -y kubectl-1.8.3-0.x86_64  kubelet-1.8.3-0.x86_64  kubeadm-1.8.3-0.x86_64  kubernetes-cni-0.5.1-1.x86_64  ----
----

[source,shell]
----
$ systemctl enable kubelet.service && systemctl start kubelet.service
----

Issue : https://github.com/kubernetes/kubernetes/issues/53333

[source,shell]
----
sed -i '/^Environment="KUBELET_KUBECONFIG_ARGS/a Environment="KUBELET_EXTRA_ARGS=--fail-swap-on=false"' /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
----

Issue: /proc/sys/net/bridge/bridge-nf-call-iptables contents are not set to 1

[source,shell]
----
$ cat <<EOF >  /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF

$ sysctl --system
----

Restart Kubectl
[source,shell]
----
$ systemctl daemon-reload
$ systemctl restart kubelet.service
----

=== Master Installation

Start Kubeadmin
[source,shell]
----
$ kubeadm init --apiserver-advertise-address=192.168.2.110 --service-cidr 192.168.2.0/24 --pod-network-cidr 192.168.2.0/24
----


Issue : kubectl get: The connection to the server localhost:8080 was refused -Kubernetes
[source,shell]
----
$ cp /etc/kubernetes/admin.conf $HOME/
$ chown $(id -u):$(id -g) $HOME/admin.conf
$ export KUBECONFIG=$HOME/admin.conf
----

Reset and restart Kubeadm
[source,shell]
----
$ kubeadm reset
$ systemctl daemon-reload
$ systemctl restart kubelet.service
----

Sources : 

- https://kubernetes.io/docs/setup/independent/install-kubeadm/#installing-docker
- https://www.data-essential.com/hands-on-kubernetes-with-kubeadm/

=== How to reset Kubeadm

[source,shell]
----
$ kubeadm reset
$ systemctl daemon-reload 
$ systemctl restart kubelet.service
----
